#!/bin/execlineb -P

redirfd -r 0 /dev/console
redirfd -w 1 /dev/console
fdmove -c 2 1

ifelse -nX
{
    if { s6-mount -t tmpfs -o nodev,mode=0755,rootcontext=system_u:object_r:var_run_t none /run }
    if { s6-mkdir /run/s6 }
    if { s6-hiercopy /etc/s6/service /run/s6/service }
    if { s6-mkfifo -m0600 /run/s6/service/s6-svscan-log/fifo }
    if { restorecon -RF /dev /run }
}
{ /etc/s6/rescue }

/bin/s6-envdir /etc/s6/env
redirfd -r 0 /dev/null
redirfd -wnb 1 /run/s6/service/s6-svscan-log/fifo

background
{
    s6-setsid --
    redirfd -w 1 /run/s6/service/s6-svscan-log/fifo
    fdmove -c 1 2  # output to /dev/console
    /etc/s6/rc.init
}

emptyenv -c
cd /run/s6/service
fdmove -c 2 1
s6-svscan -st0

#!/bin/execlineb -P

pipeline
{
    piperw 0 3
    foreground
    {
        redirfd -r 0 env/sysfs/.chmod_dirs
        fdmove 1 3
        s6-cat
    }

    background
    {
        forstdin dir
            importas dir dir

            if -t
            {
                redirfd -w 1 /dev/null
                expr $dir : ^/sys
            }

            foreground { s6-echo $dir }
            fdmove 1 3
            s6-dirname $dir
    }
    s6-sleep -m 2000
    importas ! !
    kill $! # ugly hack, neccessary since 'forstdin' won't terminate
}

redirfd -w 1 env/sysfs/chmod_dirs
sort -u
